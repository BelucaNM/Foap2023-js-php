<!DOCTYPE html>
<html>
    <head>
        <title> Formulario con desplegable y con validaciones </title>
        <meta charset="UTF-8">
    </head>
    <body>
        <form id="miForm"> 
    
            Nombre <input type="text" id="name" name="name"  minlength="4" maxlength="30" placeholder="introducir nombre"> <br>
            Apellido <input type="text" id="apellido" name="apellido"  minlength="4" maxlength="30" placeholder="introducir apellido"><br>
            <p>Provincia:   <select id="provincia" name="provincia"  onchange="javascript:updateMunicipios(this)">
                            <option value="0">Seleccione Municipio</option>
                            </select><br>
            <p>Municipio:   <select id="municipio" name="municipio"></select><br>
            Password : <input id = "psw1" type="Password" ><br>
            Reintroduzca Password :<input id = "psw2" type="Password" >
            <span id="content"></span><br>
            email <input id="email" name="email"><br>
            <span id="errores"></span><br>
            <input type="submit" value="submit" >
             
        </form>
    
    <script>

    var arrayEmails;

    function updateProvincias() {
        fetch('llistatProvincias.php')
        .then(response => {
            if (!response.ok) {
                throw new Error('No hi ha provincias');
                }
                return response.json()
                })
        .then (data => {
                provincias = data 
                console.log("provincias", provincias)
                provincias.forEach(provincia => {

                console.log ("provincia es ", provincia)
                let option = document.createElement ("option")
                option.value = provincia.id //elem.id
                option.text = provincia.name //elem.name
                console.log ("option es ", option)
                document.getElementById("provincia").appendChild(option) 
  
 
                })
            })
        .catch(error => {
                console.error('Error al rebre la llista de provincias:', error)
        })
        }
        
    function updateMunicipios() {
        document.getElementById("municipio").innerHTML ="";
        fetch('llistatMunicipios.php')
        .then(response => {
             if (!response.ok) {
                throw new Error('No hi ha municipios')
                }
                return response.json()
                })
        .then (data => {
                municipios = data; 
                console.log("municipios", municipios);
                municipios.forEach(municipio => {

                    console.log ("municipio es ", municipio);
                    let option = document.createElement ("option");
                    option.value = municipio.id;    //elem.id
                    option.text =  municipio.name;  //elem.name
                    console.log ("option es ", option);
                    document.getElementById("municipio").appendChild(option);  

                })
            })
        .catch(error => {
                console.error('Error al rebre la llista de municipios:', error)
            })
        }

    function updateEmails() {

        
        fetch('llistatEmails.php')
        .then(response => {
            if (!response.ok) {
                throw new Error('No hi ha emails enregistrats');
                }
                return response.json()
                })
        .then (data => {
                arrayEmails = data 
                console.log("Emails", arrayEmails)
                
            })
        .catch(error => {
                console.error('Error al rebre la llista de emails:', error)
        })
        }
    

    function getStrongLevel(password) {
        var level = 0;
        level += password.length > 6 ? 1 : 0;
        level += /[!@#$%^&*?_~]{2,}/.test(password) ? 1 : 0;
        level += /[a-z]{2,}/.test(password) ? 1 : 0;
        level += /[A-Z]{2,}/.test(password) ? 1 : 0;
        level += /[0-9]{2,}/.test(password) ? 1 : 0;
        return level;
    }
        
    function validaciones() { 
                
    // Password 1 == Pasword 2

        let $error = "";

        let pasw1= document.getElementById ("psw1").value;
        let pasw2= document.getElementById ("psw2").value;
        if (pasw1 !== pasw2) {$error += " Passwords no coinciden."}
        else {
        // chequea que el password es robusto   
            let level = getStrongLevel(pasw1);
            console.log("pass:", pasw1, "level:", level);
            let content = document.getElementById("content");
            if (level < 2 ) {
                content.innerText="nivell seguridad de "+ pasw1 +" es " +level+"." 
                $error += " El nivel de seguridad " +level+" del password es insuficiente. " 
                }
            }
   
      
        // email único al que corresponde un DNI
        let elEmail = document.getElementById("email").value;
        console.log ("elEmail que busco es ", elEmail)
        // arrayEmails es una variable Global
        arrayEmails.forEach(unEmail => {
                    console.log ("elEmail que encuentro es ", unEmail);
                    if (unEmail.email == elEmail) {
                        console.log ("elDNI correspondiente al mail es ", unEmail.DNI)
                        $error += " El Email ja está enregistrat."
                    }
                }) 
            
        let stringErrores = document.getElementById("errores")
        stringErrores.innerText= $error 
        
        console.log( $error.length )
        if ($error.length != 0) return true;
        else return false;
    }

    document.addEventListener("DOMContentLoaded", function() { 
        
        updateProvincias() 
        updateEmails() 

        const miForm = document.getElementById ("miForm")
        console.log ( miForm)
        miForm.addEventListener("submit", (e)=>{
            e.preventDefault()
           
            /* Perform validation. When ready to submit: */
            let hayError = validaciones()
            if (!hayError)  miForm.submit() 
        })
    })
         
// falta actualizar los campos con las variables que se han recogido para que no haya que reentrarlo
        
    </script>
    </body>
    </html>
   